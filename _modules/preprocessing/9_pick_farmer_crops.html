<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>preprocessing.9_pick_farmer_crops &mdash; GEB 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> GEB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing/preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HRUs.html">Farm-level HRUs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Agents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agents/__init__.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/farmers.html">Farmers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/ngo.html">NGO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/government.html">Government</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cwatm_model.html">CWatM Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../report.html">Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../artists.html">Artists</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../authors_page.html">Authors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GEB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>preprocessing.9_pick_farmer_crops</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for preprocessing.9_pick_farmer_crops</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">numba.core.decorators</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">zoom</span>

<span class="kn">from</span> <span class="nn">honeybees.library.raster</span> <span class="kn">import</span> <span class="n">sample_from_map</span>
<span class="kn">from</span> <span class="nn">honeybees.library.mapIO</span> <span class="kn">import</span> <span class="n">ArrayReader</span><span class="p">,</span> <span class="n">NetCDFReader</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choices</span>

<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">INPUT</span><span class="p">,</span> <span class="n">ORIGINAL_DATA</span>

<span class="n">OUTPUT_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT</span><span class="p">,</span> <span class="s1">&#39;agents&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">)</span>

<span class="n">MIRCA2000_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ORIGINAL_DATA</span><span class="p">,</span> <span class="s1">&#39;MIRCA2000&#39;</span><span class="p">)</span>
<span class="n">FARMER_LOCATIONS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">,</span> <span class="s1">&#39;farmer_locations.npy&#39;</span><span class="p">)</span>
<span class="n">ZOOM_FACTOR</span> <span class="o">=</span> <span class="mi">20</span>

<div class="viewcode-block" id="get_crop_calendar"><a class="viewcode-back" href="../../preprocessing/9_pick_farmer_crops.html#preprocessing.9_pick_farmer_crops.get_crop_calendar">[docs]</a><span class="k">def</span> <span class="nf">get_crop_calendar</span><span class="p">(</span><span class="n">unit_codes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;This function parses MIRCA2000 crop calanders from downloaded format to a convenient dictionary. In addition, the unit code map will be mapped to lower values.</span>

<span class="sd">    Args:</span>
<span class="sd">        unit_codes: Array of unit codes for study area.</span>

<span class="sd">    Returns:</span>
<span class="sd">        crop_calendar: Dictionary of crop calendars for set of attributes.</span>
<span class="sd">        map_unit_codes: Array of reduced unit codes for study area.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">map_unit_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">unit_codes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">map_unit_codes</span><span class="p">[</span><span class="n">unit_codes</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unit_codes</span><span class="p">))</span>
    <span class="n">crop_calendar_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;irrigated&#39;</span><span class="p">,</span> <span class="s1">&#39;rainfed&#39;</span><span class="p">):</span>
        <span class="n">crop_calendar_dict</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MIRCA2000_FOLDER</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cropping_calendar_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">d</span><span class="p">]</span>
                <span class="n">unit_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">unit_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unit_codes</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">mapped_unit_code</span> <span class="o">=</span> <span class="n">map_unit_codes</span><span class="p">[</span><span class="n">unit_code</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mapped_unit_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crop_calendar_dict</span><span class="p">[</span><span class="n">kind</span><span class="p">]:</span>
                    <span class="n">crop_calendar_dict</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="n">mapped_unit_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">crop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">cropping_calendar</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">cropping_calendar</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">crop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crop_calendar_dict</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="n">mapped_unit_code</span><span class="p">]:</span>
                        <span class="n">crop_calendar_dict</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="n">mapped_unit_code</span><span class="p">][</span><span class="n">crop</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cropping_calendar</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">):</span>
                        <span class="n">crop_calendar</span> <span class="o">=</span> <span class="n">cropping_calendar</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span>
                        <span class="n">crop_calendar</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">crop_calendar</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">crop_calendar</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">crop_calendar</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                        <span class="k">if</span> <span class="n">crop_calendar</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">crop_calendar_dict</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="n">mapped_unit_code</span><span class="p">][</span><span class="n">crop</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">crop_calendar</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">crop_calendar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">crop_calendar</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">crop_calendar_dict</span><span class="p">,</span> <span class="n">map_unit_codes</span></div>


<span class="k">def</span> <span class="nf">get_farm_sizes</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT</span><span class="p">,</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;farms.tif&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">farms</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT</span><span class="p">,</span> <span class="s1">&#39;areamaps&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_cell_area.tif&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">cell_area</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">cell_area</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">farms</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">cell_area</span> <span class="o">=</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">farms</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">farms</span> <span class="o">=</span> <span class="n">farms</span><span class="p">[</span><span class="n">farms</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">farm_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">farms</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">cell_area</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">farm_sizes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">farm_sizes</span>

<div class="viewcode-block" id="is_groundwater_irrigating"><a class="viewcode-back" href="../../preprocessing/9_pick_farmer_crops.html#preprocessing.9_pick_farmer_crops.is_groundwater_irrigating">[docs]</a><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">is_groundwater_irrigating</span><span class="p">(</span><span class="n">irrigating_farmers</span><span class="p">,</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">,</span> <span class="n">farms_size_ha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Below 0.5</span>
<span class="sd">    0.5-1.0</span>
<span class="sd">    1.0-2.0</span>
<span class="sd">    2.0-3.0</span>
<span class="sd">    3.0-4.0</span>
<span class="sd">    4.0-5.0</span>
<span class="sd">    5.0-7.5</span>
<span class="sd">    7.5-10.0</span>
<span class="sd">    10.0-20.0</span>
<span class="sd">    20.0 &amp; ABOVE</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">has_well</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">irrigating_farmers</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">irrigating_farmers</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">is_irrigating</span> <span class="o">=</span> <span class="n">irrigating_farmers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_irrigating</span><span class="p">:</span>
            <span class="n">farm_size_ha</span> <span class="o">=</span> <span class="n">farms_size_ha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mf">7.5</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">farm_size_ha</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_well</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">has_well</span></div>

<div class="viewcode-block" id="get_crop_and_irrigation_per_farmer"><a class="viewcode-back" href="../../preprocessing/9_pick_farmer_crops.html#preprocessing.9_pick_farmer_crops.get_crop_and_irrigation_per_farmer">[docs]</a><span class="k">def</span> <span class="nf">get_crop_and_irrigation_per_farmer</span><span class="p">(</span><span class="n">crop_calendar</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">map_unit_codes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to get crop type, irrigation type and MIRCA2000 unit code for each farmer. First, the farmer locations are loaded (as previously generated), then a map of farmer irrigation is loaded to retrieve irrigating farmers. Next, the MIRCA2000 unit codes for each farmer are retrieved. Subsequently, MIRCA2000 crop data is read and linearly interpolated to support the higher resolution grid of the model. Using the farmer locations, a crop is then randomly chosen for each farmer while considering the probablity that a certain crop is growing in that space according to the MIRCA2000 specification. Crop choice, irrigation type and unit codes per farmer are saved to the disk in NumPy arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        crop_calendar: Dictionary of crop calendars for set of attributes.</span>
<span class="sd">        map_unit_codes: Array of reduced unit codes for study area.</span>

<span class="sd">    Returns:</span>
<span class="sd">        crop_per_farmer: Chosen crop code per farmer.</span>
<span class="sd">        irrigating_farmers: Array with whether farmer is irrigating or not (Irrigating == True).</span>
<span class="sd">        farmer_unit_codes: Reduced MIRCA2000 unit code per farmer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">FARMER_LOCATIONS</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT</span><span class="p">,</span> <span class="s1">&#39;areamaps&#39;</span><span class="p">,</span> <span class="s1">&#39;mask.tif&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">top</span>

    <span class="n">irrigated_land</span> <span class="o">=</span> <span class="n">ArrayReader</span><span class="p">(</span>
        <span class="n">fp</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ORIGINAL_DATA</span><span class="p">,</span> <span class="s1">&#39;india_irrigated_land&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-2011.tif&#39;</span><span class="p">),</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span>
    <span class="p">)</span>
    <span class="n">irrigating_farmers</span> <span class="o">=</span> <span class="n">irrigated_land</span><span class="o">.</span><span class="n">sample_coords</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>

    <span class="n">groundwater_irrigated</span> <span class="o">=</span> <span class="n">ArrayReader</span><span class="p">(</span>
        <span class="n">fp</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT</span><span class="p">,</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;irrigation_source&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-11&#39;</span><span class="p">,</span> <span class="s1">&#39;irrigation_source.tif&#39;</span><span class="p">),</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span>
    <span class="p">)</span>

    <span class="n">farm_sizes</span> <span class="o">=</span> <span class="n">get_farm_sizes</span><span class="p">()</span>
    <span class="n">farm_sizes_ha</span> <span class="o">=</span> <span class="n">farm_sizes</span> <span class="o">/</span> <span class="mi">10_000</span>

    <span class="n">crop_per_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

    <span class="n">groundwater_irrigation_probabilities</span> <span class="o">=</span> <span class="n">groundwater_irrigated</span><span class="o">.</span><span class="n">sample_coords</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
    <span class="n">irrigation_correction_factor</span> <span class="o">=</span> <span class="n">irrigating_farmers</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">irrigating_farmers</span><span class="o">.</span><span class="n">size</span>
    <span class="n">groundwater_irrigation_probabilities</span> <span class="o">/=</span> <span class="n">irrigation_correction_factor</span>
    <span class="n">groundwater_irrigation_probabilities</span><span class="p">[</span><span class="n">groundwater_irrigation_probabilities</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">groundwater_irrigated_farmers</span> <span class="o">=</span> <span class="n">is_groundwater_irrigating</span><span class="p">(</span><span class="n">irrigating_farmers</span><span class="p">,</span> <span class="n">groundwater_irrigation_probabilities</span><span class="p">,</span> <span class="n">farm_sizes_ha</span><span class="p">)</span>
    <span class="n">groundwater_irrigated_farmers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">groundwater_irrigated_farmers</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">,</span> <span class="s1">&#39;is_groundwater_irrigating.npy&#39;</span><span class="p">),</span> <span class="n">groundwater_irrigated_farmers</span><span class="p">)</span>

    <span class="n">MIRCA2000_unit_code</span> <span class="o">=</span> <span class="n">ArrayReader</span><span class="p">(</span>
        <span class="n">fp</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MIRCA2000_FOLDER</span><span class="p">,</span> <span class="s1">&#39;unit_code.asc&#39;</span><span class="p">),</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span>
    <span class="p">)</span>
    <span class="n">MIRCA2000_unit_array</span> <span class="o">=</span> <span class="n">map_unit_codes</span><span class="p">[</span><span class="n">MIRCA2000_unit_code</span><span class="o">.</span><span class="n">get_data_array</span><span class="p">()</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ZOOM_FACTOR</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ZOOM_FACTOR</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

    <span class="n">crop_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rainfed&#39;</span><span class="p">,</span> <span class="s1">&#39;irrigated&#39;</span><span class="p">):</span>
        <span class="n">crop_data</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">crop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">):</span>
            <span class="n">crop_data</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="n">crop</span><span class="p">]</span> <span class="o">=</span> <span class="n">NetCDFReader</span><span class="p">(</span>
                <span class="n">fp</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MIRCA2000_FOLDER</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">crop</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">),</span>
                <span class="n">varname</span><span class="o">=</span><span class="s2">&quot;cropland&quot;</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span>
            <span class="p">)</span>

    <span class="n">ysize</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">[</span><span class="s1">&#39;rainfed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rowslice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">crop_data</span><span class="p">[</span><span class="s1">&#39;rainfed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rowslice</span><span class="o">.</span><span class="n">start</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">[</span><span class="s1">&#39;rainfed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colslice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">crop_data</span><span class="p">[</span><span class="s1">&#39;rainfed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colslice</span><span class="o">.</span><span class="n">start</span>
    <span class="n">gt</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">[</span><span class="s1">&#39;rainfed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span>
    <span class="n">gt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
    <span class="n">gt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ZOOM_FACTOR</span>
    <span class="n">gt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">gt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="n">ZOOM_FACTOR</span>
    <span class="n">gt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>

    <span class="n">all_crops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rainfed&#39;</span><span class="p">,</span> <span class="s1">&#39;irrigated&#39;</span><span class="p">):</span>

        <span class="n">excluded_crops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">unit_code</span><span class="p">,</span> <span class="n">crops</span> <span class="ow">in</span> <span class="n">crop_calendar</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">excluded_crops</span><span class="p">[</span><span class="n">unit_code</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_crops</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">crops</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;rainfed&#39;</span><span class="p">:</span>
            <span class="n">farmers_kind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">irrigating_farmers</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">farmers_kind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">irrigating_farmers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">growing_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">26</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">xsize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">crop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
                <span class="n">growing_area_crop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                    <span class="n">crop_data</span><span class="p">[</span><span class="n">kind</span><span class="p">][</span><span class="n">crop</span><span class="p">]</span><span class="o">.</span><span class="n">get_data_array</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="n">growing_areas</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">growing_areas</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">=</span> <span class="n">growing_area_crop</span>

        <span class="c1"># interpolate nan values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">growing_areas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">growing_areas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">growing_areas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">xym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">mask</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">mask</span><span class="p">])))</span><span class="o">.</span><span class="n">T</span>

        <span class="n">growing_areas_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">):</span>
            <span class="n">growing_areas_crop</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">NearestNDInterpolator</span><span class="p">(</span><span class="n">xym</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">growing_areas</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">][</span><span class="n">mask</span><span class="p">]))(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">growing_areas_crop</span><span class="p">[</span><span class="n">growing_areas_crop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">growing_areas_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">growing_areas_crop</span><span class="p">)</span>

        <span class="n">growing_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">growing_areas_list</span><span class="p">)</span>
        <span class="n">growing_areas</span> <span class="o">=</span> <span class="n">growing_areas</span> <span class="o">/</span> <span class="n">growing_areas</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># growing_areas = zoom(growing_areas, (1, ZOOM_FACTOR, ZOOM_FACTOR), order=1, grid_mode=False)</span>
        <span class="n">growing_areas_zoomed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">crop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">):</span>
            <span class="n">growing_areas_zoomed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">zoom</span><span class="p">(</span><span class="n">growing_areas</span><span class="p">[</span><span class="n">crop</span><span class="p">],</span> <span class="n">ZOOM_FACTOR</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">growing_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">growing_areas_zoomed</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">filter_crops</span><span class="p">(</span><span class="n">MIRCA2000_unit_array</span><span class="p">,</span> <span class="n">excluded_crops</span><span class="p">,</span> <span class="n">growing_areas</span><span class="p">):</span>
            <span class="n">ysize</span><span class="p">,</span> <span class="n">xsize</span> <span class="o">=</span> <span class="n">MIRCA2000_unit_array</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ysize</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="p">):</span>
                    <span class="n">unit_code</span> <span class="o">=</span> <span class="n">MIRCA2000_unit_array</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                    <span class="n">excluded_crops_cell</span> <span class="o">=</span> <span class="n">excluded_crops</span><span class="p">[</span><span class="n">unit_code</span><span class="p">]</span>
                    <span class="n">growing_areas</span><span class="p">[:,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">][</span><span class="n">excluded_crops_cell</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">growing_areas</span>
        
        <span class="n">growing_areas</span> <span class="o">=</span> <span class="n">filter_crops</span><span class="p">(</span><span class="n">MIRCA2000_unit_array</span><span class="p">,</span> <span class="n">excluded_crops</span><span class="p">,</span> <span class="n">growing_areas</span><span class="p">)</span>
        
        <span class="n">growing_areas</span> <span class="o">=</span> <span class="n">growing_areas</span> <span class="o">/</span> <span class="n">growing_areas</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># sample crop options</span>
        <span class="n">planting_schemes</span> <span class="o">=</span> <span class="n">sample_from_map</span><span class="p">(</span><span class="n">growing_areas</span><span class="p">,</span> <span class="n">locations</span><span class="p">[</span><span class="n">farmers_kind</span><span class="p">],</span> <span class="n">gt</span><span class="p">)</span>

        <span class="c1"># randomly select crop</span>
        <span class="n">crop_choice</span> <span class="o">=</span> <span class="p">(</span><span class="n">planting_schemes</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">planting_schemes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># assign crop choice to self</span>
        <span class="n">crop_per_farmer</span><span class="p">[</span><span class="n">farmers_kind</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_choice</span>

    <span class="c1"># just make sure all farmers were assigned a crop</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">crop_per_farmer</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">,</span> <span class="s1">&#39;crop.npy&#39;</span><span class="p">),</span> <span class="n">crop_per_farmer</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">,</span> <span class="s1">&#39;irrigating.npy&#39;</span><span class="p">),</span> <span class="n">irrigating_farmers</span><span class="p">)</span>

    <span class="n">farmer_unit_codes</span> <span class="o">=</span> <span class="n">map_unit_codes</span><span class="p">[</span><span class="n">MIRCA2000_unit_code</span><span class="o">.</span><span class="n">sample_coords</span><span class="p">(</span><span class="n">locations</span><span class="p">)]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">,</span> <span class="s1">&#39;farmer_unit_codes.npy&#39;</span><span class="p">),</span> <span class="n">farmer_unit_codes</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">crop_per_farmer</span><span class="p">,</span> <span class="n">irrigating_farmers</span><span class="p">,</span> <span class="n">farmer_unit_codes</span></div>

<div class="viewcode-block" id="overlap"><a class="viewcode-back" href="../../preprocessing/9_pick_farmer_crops.html#preprocessing.9_pick_farmer_crops.overlap">[docs]</a><span class="k">def</span> <span class="nf">overlap</span><span class="p">(</span><span class="n">r1</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">r2</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check whether 2 sets overlap. Used to check whether 2 crops overlap in growth period.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        r1: Set of growing months for first crop.</span>
<span class="sd">        r2: Set of growing months for second crop.</span>

<span class="sd">    Returns:</span>
<span class="sd">        overlap: True if crop growth periods overlap, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1</span> <span class="o">|</span> <span class="n">r2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_range_months"><a class="viewcode-back" href="../../preprocessing/9_pick_farmer_crops.html#preprocessing.9_pick_farmer_crops.get_range_months">[docs]</a><span class="k">def</span> <span class="nf">get_range_months</span><span class="p">(</span><span class="n">potential_crops</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">set</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets growing months for list of crops.</span>

<span class="sd">    Args:</span>
<span class="sd">        potential_crops: List of crops, specifying start and end of growing period in dict as follows: [{&#39;start&#39;: ..., &#39;end&#39;: ...}, ..., {...}]</span>

<span class="sd">    Returns:</span>
<span class="sd">        growth_range_months: List of crops (same as function input) and their growing months as a set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">growth_range_months</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">crop</span> <span class="ow">in</span> <span class="n">potential_crops</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">crop</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">crop</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">+=</span> <span class="mi">12</span>
            <span class="n">months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="mi">12</span>
            <span class="n">months</span><span class="p">[</span><span class="n">months</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">growth_range_months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">months</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">growth_range_months</span></div>

<div class="viewcode-block" id="get_planting_schemes"><a class="viewcode-back" href="../../preprocessing/9_pick_farmer_crops.html#preprocessing.9_pick_farmer_crops.get_planting_schemes">[docs]</a><span class="k">def</span> <span class="nf">get_planting_schemes</span><span class="p">(</span><span class="n">crop_calendars</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">crop_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">farmer_unit_codes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multiple planting schemes (e.g., single, multi-cropping) exist for some crops in MIRCA2000. This function is used to create the cropping options. Results are saved as a 6-dimensional NumPy arrays, specifying all the different options. While not very easy to work with, it allows the model to be much better than for example with a JSON-file.</span>

<span class="sd">    Args:</span>
<span class="sd">        crop_calendars: Dictionary of crop calendars for set of attributes.</span>
<span class="sd">        crop_per_farmer: Chosen crop code per farmer.</span>
<span class="sd">        farmer_unit_codes: Reduced MIRCA2000 unit code per farmer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        planting_schemes: A 6-dimensional array which contains the planing schemes.</span>
<span class="sd">            1. Whether the crop is irrigated or not.</span>
<span class="sd">            2. The unit code for the crop.</span>
<span class="sd">            3. The crop.</span>
<span class="sd">            4. The planting scheme (e.g., single or double cropping).</span>
<span class="sd">            5. If multicropping, the various crop stages.</span>
<span class="sd">            6. The planting month and the harvest month.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">planting_schemes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">farmer_unit_codes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>  <span class="c1"># is_irrigating, unit_code, crop, crop_selection, max_multicrop, start, end, weight</span>
    <span class="n">unique_unit_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">farmer_unit_codes</span><span class="p">)</span>
    <span class="n">unique_crops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">crop_per_farmer</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">is_irrigating</span><span class="p">,</span> <span class="n">is_irrigating_name</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;rainfed&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;irrigated&#39;</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">unit_code</span> <span class="ow">in</span> <span class="n">unique_unit_codes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">crop</span> <span class="ow">in</span> <span class="n">unique_crops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">crop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crop_calendars</span><span class="p">[</span><span class="n">is_irrigating_name</span><span class="p">][</span><span class="n">unit_code</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">potential_crops</span> <span class="o">=</span> <span class="n">crop_calendars</span><span class="p">[</span><span class="n">is_irrigating_name</span><span class="p">][</span><span class="n">unit_code</span><span class="p">][</span><span class="n">crop</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">potential_crops</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">potential_crops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">planting_schemes</span><span class="p">[</span><span class="n">is_irrigating</span><span class="p">,</span> <span class="n">unit_code</span><span class="p">,</span> <span class="n">crop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">potential_crops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">potential_crops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">potential_crops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="n">get_range_months</span><span class="p">(</span><span class="n">potential_crops</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">overlap</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># no multicropping</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                            <span class="n">planting_schemes</span><span class="p">[</span><span class="n">is_irrigating</span><span class="p">,</span> <span class="n">unit_code</span><span class="p">,</span> <span class="n">crop</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">potential_crops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">potential_crops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="n">potential_crops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;area&#39;</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># multicropping</span>
                        <span class="k">assert</span> <span class="n">potential_crops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">potential_crops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;area&#39;</span><span class="p">]</span>
                        <span class="n">planting_schemes</span><span class="p">[</span><span class="n">is_irrigating</span><span class="p">,</span> <span class="n">unit_code</span><span class="p">,</span> <span class="n">crop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">potential_crops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">potential_crops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">planting_schemes</span><span class="p">[</span><span class="n">is_irrigating</span><span class="p">,</span> <span class="n">unit_code</span><span class="p">,</span> <span class="n">crop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">potential_crops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">potential_crops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">potential_crops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="n">get_range_months</span><span class="p">(</span><span class="n">potential_crops</span><span class="p">)</span>
                    <span class="n">crops_overlap</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">overlap</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="n">crops_overlap</span><span class="p">:</span>  <span class="c1"># no multicropping</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                            <span class="n">planting_schemes</span><span class="p">[</span><span class="n">is_irrigating</span><span class="p">,</span> <span class="n">unit_code</span><span class="p">,</span> <span class="n">crop</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">potential_crops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">potential_crops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="n">potential_crops</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;area&#39;</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;multicropping for 3 crops is not implemented&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Only max of 3 crops is currently implemented&#39;</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">,</span> <span class="s1">&#39;planting_schemes.npy&#39;</span><span class="p">),</span> <span class="n">planting_schemes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">planting_schemes</span></div>

<div class="viewcode-block" id="pick_planting_scheme"><a class="viewcode-back" href="../../preprocessing/9_pick_farmer_crops.html#preprocessing.9_pick_farmer_crops.pick_planting_scheme">[docs]</a><span class="k">def</span> <span class="nf">pick_planting_scheme</span><span class="p">(</span><span class="n">planting_schemes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">irrigating_farmers</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">crop_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">farmer_unit_codes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Here the farmers pick one of the planting schemes relative to the growing area of their crop and irrigation type in the area. Saves the planting scheme to a numpy-array.</span>

<span class="sd">    Args:</span>
<span class="sd">        planting_schemes: A 6-dimensional array which contains the planing schemes.</span>
<span class="sd">            1. Whether the crop is irrigated or not.</span>
<span class="sd">            2. The unit code for the crop.</span>
<span class="sd">            3. The crop.</span>
<span class="sd">            4. The planting scheme (e.g., single or double cropping).</span>
<span class="sd">            5. If multicropping, the various crop stages.</span>
<span class="sd">            6. The planting month and the harvest month.</span>
<span class="sd">        irrigating_farmers: Array with whether farmer is irrigating or not (Irrigating == True).</span>
<span class="sd">        crop_per_farmer: Chosen crop code per farmer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">planting_scheme</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">crop_per_farmer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">irrigating_farmers</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">is_irrigating</span> <span class="o">=</span> <span class="n">irrigating_farmers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">unit_code</span> <span class="o">=</span> <span class="n">farmer_unit_codes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">crop</span> <span class="o">=</span> <span class="n">crop_per_farmer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">crop_options</span> <span class="o">=</span> <span class="n">planting_schemes</span><span class="p">[</span><span class="n">is_irrigating</span><span class="p">][</span><span class="n">unit_code</span><span class="p">][</span><span class="n">crop</span><span class="p">]</span>
        <span class="n">n_options</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_options</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n_options</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">planting_scheme</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">crop_options</span><span class="p">[:</span><span class="n">n_options</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">planting_scheme</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">choices</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_options</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">crop_options</span><span class="p">[:</span><span class="n">n_options</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_FOLDER</span><span class="p">,</span> <span class="s1">&#39;planting_scheme.npy&#39;</span><span class="p">),</span> <span class="n">planting_scheme</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">crop_calendar</span><span class="p">,</span> <span class="n">map_unit_codes</span> <span class="o">=</span> <span class="n">get_crop_calendar</span><span class="p">(</span><span class="n">unit_codes</span><span class="o">=</span><span class="p">[</span>
        <span class="mi">356001</span><span class="p">,</span> <span class="mi">356002</span><span class="p">,</span> <span class="mi">356003</span><span class="p">,</span> <span class="mi">356004</span><span class="p">,</span> <span class="mi">356005</span><span class="p">,</span>
        <span class="mi">356006</span><span class="p">,</span> <span class="mi">356007</span><span class="p">,</span> <span class="mi">356008</span><span class="p">,</span> <span class="mi">356009</span><span class="p">,</span> <span class="mi">356010</span><span class="p">,</span>
        <span class="mi">356011</span><span class="p">,</span> <span class="mi">356012</span><span class="p">,</span> <span class="mi">356013</span><span class="p">,</span> <span class="mi">356014</span><span class="p">,</span> <span class="mi">356015</span><span class="p">,</span>
        <span class="mi">356016</span><span class="p">,</span> <span class="mi">356017</span><span class="p">,</span> <span class="mi">356018</span><span class="p">,</span> <span class="mi">356019</span><span class="p">,</span> <span class="mi">356020</span><span class="p">,</span>
        <span class="mi">356021</span><span class="p">,</span> <span class="mi">356022</span><span class="p">,</span> <span class="mi">356023</span><span class="p">,</span> <span class="mi">356024</span><span class="p">,</span> <span class="mi">356025</span><span class="p">,</span>
        <span class="mi">356026</span><span class="p">,</span> <span class="mi">356027</span><span class="p">,</span> <span class="mi">356028</span><span class="p">,</span> <span class="mi">356029</span><span class="p">,</span> <span class="mi">356030</span><span class="p">,</span>
        <span class="mi">356031</span><span class="p">,</span> <span class="mi">356032</span><span class="p">,</span> <span class="mi">356033</span><span class="p">,</span> <span class="mi">356034</span><span class="p">,</span> <span class="mi">356035</span>
    <span class="p">])</span>
    <span class="n">crop_per_farmer</span><span class="p">,</span> <span class="n">irrigating_farmers</span><span class="p">,</span> <span class="n">farmer_unit_codes</span> <span class="o">=</span> <span class="n">get_crop_and_irrigation_per_farmer</span><span class="p">(</span><span class="n">crop_calendar</span><span class="p">,</span> <span class="n">map_unit_codes</span><span class="p">)</span>
    <span class="n">planting_schemes</span> <span class="o">=</span> <span class="n">get_planting_schemes</span><span class="p">(</span><span class="n">crop_calendar</span><span class="p">,</span> <span class="n">crop_per_farmer</span><span class="p">,</span> <span class="n">farmer_unit_codes</span><span class="p">)</span>
    <span class="n">pick_planting_scheme</span><span class="p">(</span><span class="n">planting_schemes</span><span class="p">,</span> <span class="n">irrigating_farmers</span><span class="p">,</span> <span class="n">crop_per_farmer</span><span class="p">,</span> <span class="n">farmer_unit_codes</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2022, IIASA and VU-IVM.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>