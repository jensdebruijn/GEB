<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agents.farmers &mdash; GEB 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> GEB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing/preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HRUs.html">Farm-level HRUs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Agents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agents/__init__.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/farmers.html">Farmers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/ngo.html">NGO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/government.html">Government</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cwatm_model.html">CWatM Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../report.html">Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../artists.html">Artists</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../authors_page.html">Authors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GEB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
          <li><a href="../agents.html">agents</a> &raquo;</li>
      <li>agents.farmers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agents.farmers</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cupy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>

<span class="kn">from</span> <span class="nn">honeybees.library.mapIO</span> <span class="kn">import</span> <span class="n">ArrayReader</span>
<span class="kn">from</span> <span class="nn">honeybees.library.neighbors</span> <span class="kn">import</span> <span class="n">find_neighbors</span>
<span class="kn">from</span> <span class="nn">honeybees.agents</span> <span class="kn">import</span> <span class="n">AgentBaseClass</span>


<div class="viewcode-block" id="is_currently_growing"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.is_currently_growing">[docs]</a><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">is_currently_growing</span><span class="p">(</span><span class="n">plant_month</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">harvest_month</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_month</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_day</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_day_per_month</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Checks whether a crop is currently growing based on the plant month, harvest month, and current model date. Used for initalization of the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        plant_month: month that the crop is planted.</span>
<span class="sd">        harvest_month: month that the crop is harvested.</span>
<span class="sd">        current_month: Current month.</span>
<span class="sd">        current_day: Current day year.</span>
<span class="sd">        start_day_per_month: 1d NumPy array with starting day per month [31, ..., 31]</span>

<span class="sd">    Returns:</span>
<span class="sd">        crop_age_days: Crop age in days at current day. Returns -1 when crop is not currently growing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">harvest_month</span> <span class="o">&lt;</span> <span class="n">plant_month</span><span class="p">:</span>
        <span class="n">harvest_month</span> <span class="o">+=</span> <span class="mi">12</span>
    <span class="k">if</span> <span class="n">current_month</span> <span class="o">&gt;=</span> <span class="n">plant_month</span> <span class="ow">and</span> <span class="n">current_month</span> <span class="o">&lt;</span> <span class="n">harvest_month</span><span class="p">:</span>
        <span class="n">crop_age_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_day</span> <span class="o">-</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">plant_month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="mi">365</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">crop_age_days</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">crop_age_days</span></div>

<div class="viewcode-block" id="get_farmer_fields"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.get_farmer_fields">[docs]</a><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">get_farmer_fields</span><span class="p">(</span><span class="n">field_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">field_indices_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">farmer_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Gets indices of field for given farmer.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        field_indices_per_farmer: This array contains the indices where the fields of a farmer are stored in `field_indices`.</span>
<span class="sd">        field_indices: This array contains the indices of all fields, ordered by farmer. In other words, if a farmer owns multiple fields, the indices of the fields are indices.  </span>

<span class="sd">    Returns:</span>
<span class="sd">        field_indices_for_farmer: the indices of the fields for the given farmer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">field_indices</span><span class="p">[</span><span class="n">field_indices_per_farmer</span><span class="p">[</span><span class="n">farmer_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span> <span class="n">field_indices_per_farmer</span><span class="p">[</span><span class="n">farmer_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span></div>

<span class="k">def</span> <span class="nf">take_with_ignore</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">ignore_index</span><span class="p">,</span> <span class="n">ignore_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="n">array</span><span class="p">[</span><span class="n">indices</span> <span class="o">==</span> <span class="n">ignore_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignore_value</span>
    <span class="k">return</span> <span class="n">array</span>


<div class="viewcode-block" id="Farmers"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers">[docs]</a><span class="k">class</span> <span class="nc">Farmers</span><span class="p">(</span><span class="n">AgentBaseClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The agent class for the farmers. Contains all data and behaviourial methods. The __init__ function only gets the model as arguments, the agent parent class and the redundancy. All other variables are loaded at later stages.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        model: The GEB model.</span>
<span class="sd">        agents: The class that includes all agent types (allowing easier communication between agents).</span>
<span class="sd">        redundancy: a lot of data is saved in pre-allocated NumPy arrays. While this allows much faster operation, it does mean that the number of agents cannot grow beyond the size of the pre-allocated arrays. This parameter allows you to specify how much redundancy should be used. A lower redundancy means less memory is used, but the model crashes if the redundancy is insufficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">reduncancy</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="n">agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">HRU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redundancy</span> <span class="o">=</span> <span class="n">reduncancy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop_yield_factors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_crop_yield_factors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initiate_agents</span><span class="p">()</span>

<div class="viewcode-block" id="Farmers.initiate_agents"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.initiate_agents">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calls functions to initialize all agent attributes, including their locations. Then, crops are initially planted. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_field_indices</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">initiate_locations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initiate_attributes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plant_initial</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;initialized </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s1"> agents&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Farmers.initiate_locations"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.initiate_locations">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads locations of the farmers from .npy-file and saves to self.locations. Sets self.n to the current numbers of farmers, and sets self.max_n to the maximum number of farmers that can be expected in the model (model will fail if more than max_n farmers.) considering reducancy parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agent_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;farmer_locations.npy&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">agent_locations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_n</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">redundancy</span><span class="p">))</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_n</span> <span class="o">&lt;</span> <span class="mi">4294967295</span> <span class="c1"># max value of uint32, consider replacing with uint64</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locations</span> <span class="o">=</span> <span class="n">agent_locations</span></div>

<div class="viewcode-block" id="Farmers.initiate_attributes"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.initiate_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is used to initiate all agent attributes, such as crop type, irrigiation type and elevation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elevation_map</span> <span class="o">=</span> <span class="n">ArrayReader</span><span class="p">(</span>
            <span class="n">fp</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;landsurface&#39;</span><span class="p">,</span> <span class="s1">&#39;topo&#39;</span><span class="p">,</span> <span class="s1">&#39;subelv.tif&#39;</span><span class="p">),</span>
            <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bounds</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span> <span class="o">=</span> <span class="n">elevation_map</span><span class="o">.</span><span class="n">sample_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
        <span class="n">crop_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;crop.npy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_crop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">crop_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_irrigating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irrigating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;irrigating.npy&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groundwater_irrigating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groundwater_irrigating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;is_groundwater_irrigating.npy&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_planting_scheme</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planting_scheme</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;planting_scheme.npy&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit_code</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_code</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;farmer_unit_codes.npy&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_paddy_irrigated</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_paddy_irrigated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_paddy_irrigated</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">crop</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># set rice to paddy-irrigated</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_yield_ratio_per_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_water_efficient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_harvests</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_abstraction_m3_by_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reservoir_abstraction_m3_by_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groundwater_abstraction_m3_by_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_water_availability_by_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_water_limited_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">planting_schemes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;planting_schemes.npy&#39;</span><span class="p">))</span>
        
        <span class="c1"># Set planting scheme for sugarcane in all regions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planting_schemes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planting_schemes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planting_schemes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_transpiration_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">full_compressed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">potential_transpiration_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">full_compressed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="Farmers.update_field_indices_numba"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.update_field_indices_numba">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_field_indices_numba</span><span class="p">(</span><span class="n">land_owners</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates `field_indices_per_farmer` and `field_indices`. These indices are used to quickly find the fields for a specific farmer.</span>

<span class="sd">        Args:</span>
<span class="sd">            land_owners: Array of the land owners. Each unique ID is a different land owner. -1 means the land is not owned by anyone.</span>

<span class="sd">        Returns:</span>
<span class="sd">            field_indices_per_farmer: This array contains the indices where the fields of a farmer are stored in `field_indices`.</span>
<span class="sd">            field_indices: This array contains the indices of all fields, ordered by farmer. In other words, if a farmer owns multiple fields, the indices of the fields are indices.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">land_owners</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">agents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_agents</span> <span class="o">=</span> <span class="n">agents</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_agents</span> <span class="o">=</span> <span class="n">agents</span><span class="o">.</span><span class="n">size</span>
        <span class="n">field_indices_per_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_agents</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">field_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">land_owners</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">land_owners_sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">land_owners</span><span class="p">)</span>
        <span class="n">land_owners_sorted</span> <span class="o">=</span> <span class="n">land_owners</span><span class="p">[</span><span class="n">land_owners_sort_idx</span><span class="p">]</span>

        <span class="n">last_not_owned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">land_owners_sorted</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

        <span class="n">prev_land_owner</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_not_owned</span><span class="p">,</span> <span class="n">land_owners</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">land_owner</span> <span class="o">=</span> <span class="n">land_owners</span><span class="p">[</span><span class="n">land_owners_sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">land_owner</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">land_owner</span> <span class="o">!=</span> <span class="n">prev_land_owner</span><span class="p">:</span>
                    <span class="n">field_indices_per_farmer</span><span class="p">[</span><span class="n">land_owner</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">last_not_owned</span>
                <span class="n">field_indices_per_farmer</span><span class="p">[</span><span class="n">land_owner</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">last_not_owned</span>
                <span class="n">field_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">last_not_owned</span><span class="p">]</span> <span class="o">=</span> <span class="n">land_owners_sort_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">prev_land_owner</span> <span class="o">=</span> <span class="n">land_owner</span>
        <span class="n">field_indices</span> <span class="o">=</span> <span class="n">field_indices</span><span class="p">[:</span><span class="o">-</span><span class="n">last_not_owned</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">field_indices_per_farmer</span><span class="p">,</span> <span class="n">field_indices</span></div>

<div class="viewcode-block" id="Farmers.update_field_indices"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.update_field_indices">[docs]</a>    <span class="k">def</span> <span class="nf">update_field_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates `field_indices_per_farmer` and `field_indices`. These indices are used to quickly find the fields for a specific farmer.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_indices_per_farmer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_field_indices_numba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_owners</span><span class="p">)</span></div>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">activation_order_by_elevation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activation order is determined by the agent elevation, starting from the highest.</span>
<span class="sd">        Agents with the same elevation are randomly shuffled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if activation order is fixed. Get the random state, and set a fixed seet.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;agent_settings&#39;</span><span class="p">][</span><span class="s1">&#39;fix_activation_order&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;activation_order_by_elevation_fixed&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation_order_by_elevation_fixed</span>
            <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span>
        <span class="c1"># Shuffle agent elevation and agent_ids in unision.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">elevation</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="c1"># if activation order is fixed, set random state to previous state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;agent_settings&#39;</span><span class="p">][</span><span class="s1">&#39;fix_activation_order&#39;</span><span class="p">]:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">elevation_shuffled</span> <span class="o">=</span> <span class="n">elevation</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">agent_ids_shuffled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">elevation</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[</span><span class="n">p</span><span class="p">]</span>
        <span class="c1"># Use argsort to find the order or the shuffled elevation. Using a stable sorting</span>
        <span class="c1"># algorithm such that the random shuffling in the previous step is conserved</span>
        <span class="c1"># in groups with identical elevation.</span>
        <span class="n">activation_order_shuffled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">elevation_shuffled</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stable&quot;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">argsort_agend_ids</span> <span class="o">=</span> <span class="n">agent_ids_shuffled</span><span class="p">[</span><span class="n">activation_order_shuffled</span><span class="p">]</span>
        <span class="c1"># Return the agent ids ranks in the order of activation.</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">argsort_agend_ids</span><span class="p">)</span>
        <span class="n">ranks</span><span class="p">[</span><span class="n">argsort_agend_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">argsort_agend_ids</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;agent_settings&#39;</span><span class="p">][</span><span class="s1">&#39;fix_activation_order&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activation_order_by_elevation_fixed</span> <span class="o">=</span> <span class="n">ranks</span>
        <span class="k">return</span> <span class="n">ranks</span>

<div class="viewcode-block" id="Farmers.abstract_water_numba"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.abstract_water_numba">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">abstract_water_numba</span><span class="p">(</span>
        <span class="n">activation_order</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">field_indices_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">field_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">water_limited_days</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">is_water_efficient</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">irrigated</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">groundwater_irrigated</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">cell_area</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">HRU_to_grid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">crop_map</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">totalPotIrrConsumption</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">available_channel_storage_m3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">available_groundwater_m3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">groundwater_head</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">available_reservoir_storage_m3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">command_areas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">return_fraction</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is used to regulate the irrigation behavior of farmers. The farmers are &quot;activated&quot; by the given `activation_order` and each farmer can irrigate from the various water sources, given water is available and the farmers has the means to abstract water. The abstraction order is channel irrigation, reservoir irrigation, groundwater irrigation. </span>

<span class="sd">        Args:</span>
<span class="sd">            activation_order: Order in which the agents are activated. Agents that are activated first get a first go at extracting water, leaving less water for other farmers.</span>
<span class="sd">            field_indices_per_farmer: This array contains the indices where the fields of a farmer are stored in `field_indices`.</span>
<span class="sd">            field_indices: This array contains the indices of all fields, ordered by farmer. In other words, if a farmer owns multiple fields, the indices of the fields are indices.  </span>
<span class="sd">            water_limited_days: Current number of days where farmer has been water limited.</span>
<span class="sd">            is_water_efficient: Boolean array that specifies whether the specific farmer is efficient with water use.</span>
<span class="sd">            irrigated: Array that specifies whether a farm is irrigated.</span>
<span class="sd">            groundwater_irrigated: Array that specifies whether a farm is groundwater irrigated.</span>
<span class="sd">            cell_area: The area of each subcell in m2.</span>
<span class="sd">            HRU_to_grid: Array to map the index of each subcell to the corresponding cell.</span>
<span class="sd">            crop_map: Map of the currently growing crops.</span>
<span class="sd">            totalPotIrrConsumption: Potential irrigation consumption.</span>
<span class="sd">            available_channel_storage_m3: Water available for irrigation from channels.</span>
<span class="sd">            groundwater_head: Groundwater head.</span>
<span class="sd">            available_groundwater_m3: Water available for irrigation from groundwater.</span>
<span class="sd">            available_reservoir_storage_m3: Water available for irrigation from reservoirs.</span>
<span class="sd">            command_areas: Command areas associated with reservoirs (i.e., which areas can access water from which reservoir.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            channel_abstraction_m3_by_farmer: Channel abstraction by farmer in m3.</span>
<span class="sd">            reservoir_abstraction_m3_by_farmer: Revervoir abstraction by farmer in m3.</span>
<span class="sd">            groundwater_abstraction_m3_by_farmer: Groundwater abstraction by farmer in m3.</span>
<span class="sd">            water_withdrawal_m: Water withdrawal in meters.</span>
<span class="sd">            water_consumption_m: Water consumption in meters.</span>
<span class="sd">            returnFlowIrr_m: Return flow in meters.</span>
<span class="sd">            addtoevapotrans_m: Evaporated irrigation water in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">land_unit_array_size</span> <span class="o">=</span> <span class="n">cell_area</span><span class="o">.</span><span class="n">size</span>
        <span class="n">water_withdrawal_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">land_unit_array_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">water_consumption_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">land_unit_array_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="n">returnFlowIrr_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">land_unit_array_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">addtoevapotrans_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">land_unit_array_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="n">groundwater_abstraction_m3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">available_groundwater_m3</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">channel_abstraction_m3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">available_channel_storage_m3</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="n">reservoir_abstraction_m_per_basin_m3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">available_reservoir_storage_m3</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">reservoir_abstraction_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">land_unit_array_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">channel_abstraction_m3_by_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">activation_order</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">reservoir_abstraction_m3_by_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">activation_order</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">groundwater_abstraction_m3_by_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">activation_order</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">activated_farmer_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">activation_order</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">farmer</span> <span class="o">=</span> <span class="n">activation_order</span><span class="p">[</span><span class="n">activated_farmer_index</span><span class="p">]</span>
            <span class="n">farmer_fields</span> <span class="o">=</span> <span class="n">get_farmer_fields</span><span class="p">(</span><span class="n">field_indices</span><span class="p">,</span> <span class="n">field_indices_per_farmer</span><span class="p">,</span> <span class="n">farmer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_water_efficient</span><span class="p">[</span><span class="n">farmer</span><span class="p">]:</span>
                <span class="n">efficiency</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">efficiency</span> <span class="o">=</span> <span class="mf">0.6</span>
            
            <span class="k">if</span> <span class="n">irrigated</span><span class="p">[</span><span class="n">farmer</span><span class="p">]:</span>
                <span class="n">farmer_is_water_limited</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">farmer_fields</span><span class="p">:</span>
                    <span class="n">f_var</span> <span class="o">=</span> <span class="n">HRU_to_grid</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                    <span class="n">crop</span> <span class="o">=</span> <span class="n">crop_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                    <span class="n">irrigation_water_demand_cell</span> <span class="o">=</span> <span class="n">totalPotIrrConsumption</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">/</span> <span class="n">efficiency</span>
                    
                    <span class="k">if</span> <span class="n">crop</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># channel abstraction</span>
                        <span class="n">available_channel_storage_cell_m</span> <span class="o">=</span> <span class="n">available_channel_storage_m3</span><span class="p">[</span><span class="n">f_var</span><span class="p">]</span> <span class="o">/</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                        <span class="n">channel_abstraction_cell_m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">available_channel_storage_cell_m</span><span class="p">,</span> <span class="n">irrigation_water_demand_cell</span><span class="p">)</span>
                        <span class="n">channel_abstraction_cell_m3</span> <span class="o">=</span> <span class="n">channel_abstraction_cell_m</span> <span class="o">*</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                        <span class="n">available_channel_storage_m3</span><span class="p">[</span><span class="n">f_var</span><span class="p">]</span> <span class="o">-=</span> <span class="n">channel_abstraction_cell_m3</span>
                        <span class="n">water_withdrawal_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="n">channel_abstraction_cell_m</span>
                        <span class="n">channel_abstraction_m3</span><span class="p">[</span><span class="n">f_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_abstraction_cell_m3</span>

                        <span class="n">channel_abstraction_m3_by_farmer</span><span class="p">[</span><span class="n">farmer</span><span class="p">]</span> <span class="o">+=</span> <span class="n">channel_abstraction_cell_m3</span>
                        
                        <span class="n">irrigation_water_demand_cell</span> <span class="o">-=</span> <span class="n">channel_abstraction_cell_m</span>
                        
                        <span class="c1"># command areas</span>
                        <span class="n">command_area</span> <span class="o">=</span> <span class="n">command_areas</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">command_area</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># -1 means no command area</span>
                            <span class="n">water_demand_cell_M3</span> <span class="o">=</span> <span class="n">irrigation_water_demand_cell</span> <span class="o">*</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                            <span class="n">reservoir_abstraction_m_cell_m3</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">available_reservoir_storage_m3</span><span class="p">[</span><span class="n">command_area</span><span class="p">],</span> <span class="n">water_demand_cell_M3</span><span class="p">)</span>
                            <span class="n">available_reservoir_storage_m3</span><span class="p">[</span><span class="n">command_area</span><span class="p">]</span> <span class="o">-=</span> <span class="n">reservoir_abstraction_m_cell_m3</span>
                            <span class="n">reservoir_abstraction_m_per_basin_m3</span><span class="p">[</span><span class="n">command_area</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reservoir_abstraction_m_cell_m3</span>
                            <span class="n">reservoir_abstraction_m_cell</span> <span class="o">=</span> <span class="n">reservoir_abstraction_m_cell_m3</span> <span class="o">/</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                            <span class="n">reservoir_abstraction_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reservoir_abstraction_m_cell</span>
                            <span class="n">water_withdrawal_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reservoir_abstraction_m_cell</span>

                            <span class="n">reservoir_abstraction_m3_by_farmer</span><span class="p">[</span><span class="n">farmer</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reservoir_abstraction_m_cell_m3</span>
                            
                            <span class="n">irrigation_water_demand_cell</span> <span class="o">-=</span> <span class="n">reservoir_abstraction_m_cell</span>

                        <span class="k">if</span> <span class="n">groundwater_irrigated</span><span class="p">[</span><span class="n">farmer</span><span class="p">]:</span>
                            <span class="c1"># groundwater irrigation</span>
                            <span class="n">available_groundwater_cell_m</span> <span class="o">=</span> <span class="n">available_groundwater_m3</span><span class="p">[</span><span class="n">f_var</span><span class="p">]</span> <span class="o">/</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                            <span class="n">groundwater_abstraction_cell_m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">available_groundwater_cell_m</span><span class="p">,</span> <span class="n">irrigation_water_demand_cell</span><span class="p">)</span>
                            <span class="n">groundwater_abstraction_cell_m3</span> <span class="o">=</span> <span class="n">groundwater_abstraction_cell_m</span> <span class="o">*</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                            <span class="n">groundwater_abstraction_m3</span><span class="p">[</span><span class="n">f_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">groundwater_abstraction_cell_m3</span>
                            <span class="n">available_groundwater_m3</span><span class="p">[</span><span class="n">f_var</span><span class="p">]</span> <span class="o">-=</span> <span class="n">groundwater_abstraction_cell_m3</span>
                            <span class="n">water_withdrawal_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="n">groundwater_abstraction_cell_m</span>

                            <span class="n">groundwater_abstraction_m3_by_farmer</span><span class="p">[</span><span class="n">farmer</span><span class="p">]</span> <span class="o">+=</span> <span class="n">groundwater_abstraction_cell_m3</span>
                    
                            <span class="n">irrigation_water_demand_cell</span> <span class="o">-=</span> <span class="n">groundwater_abstraction_cell_m</span>
                    
                    <span class="k">assert</span> <span class="n">irrigation_water_demand_cell</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">1e15</span>  <span class="c1"># Make sure irrigation water demand is zero, or positive. Allow very small error.</span>

                    <span class="k">if</span> <span class="n">irrigation_water_demand_cell</span> <span class="o">&gt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                        <span class="n">farmer_is_water_limited</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">water_consumption_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">water_withdrawal_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">*</span> <span class="n">efficiency</span>
                    <span class="n">irrigation_loss_m</span> <span class="o">=</span> <span class="n">water_withdrawal_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">-</span> <span class="n">water_consumption_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                    <span class="n">returnFlowIrr_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">irrigation_loss_m</span> <span class="o">*</span> <span class="n">return_fraction</span>
                    <span class="n">addtoevapotrans_m</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">irrigation_loss_m</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">return_fraction</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">farmer_is_water_limited</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">farmer_is_water_limited</span><span class="p">:</span>
                <span class="n">water_limited_days</span><span class="p">[</span><span class="n">farmer</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">channel_abstraction_m3_by_farmer</span><span class="p">,</span>
            <span class="n">reservoir_abstraction_m3_by_farmer</span><span class="p">,</span>
            <span class="n">groundwater_abstraction_m3_by_farmer</span><span class="p">,</span>
            <span class="n">water_withdrawal_m</span><span class="p">,</span>
            <span class="n">water_consumption_m</span><span class="p">,</span>
            <span class="n">returnFlowIrr_m</span><span class="p">,</span>
            <span class="n">addtoevapotrans_m</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Farmers.abstract_water"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.abstract_water">[docs]</a>    <span class="k">def</span> <span class="nf">abstract_water</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cell_area</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">HRU_to_grid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">totalPotIrrConsumption</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">available_channel_storage_m3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">available_groundwater_m3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">groundwater_head</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">available_reservoir_storage_m3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">command_areas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function allows the abstraction of water by farmers for irrigation purposes. It&#39;s main purpose is to call the relevant numba function to do the actual abstraction. In addition, the function saves the abstraction from the various sources by farmer.</span>

<span class="sd">        Args:</span>
<span class="sd">            cell_area: the area of each subcell in m2.</span>
<span class="sd">            HRU_to_grid: array to map the index of each subcell to the corresponding cell.</span>
<span class="sd">            totalPotIrrConsumption: potential irrigation consumption.</span>
<span class="sd">            available_channel_storage_m3: water available for irrigation from channels.</span>
<span class="sd">            groundwater_head: groundwater head.</span>
<span class="sd">            available_groundwater_m3: water available for irrigation from groundwater.</span>
<span class="sd">            available_reservoir_storage_m3: water available for irrigation from reservoirs.</span>
<span class="sd">            command_areas: command areas associated with reservoirs (i.e., which areas can access water from which reservoir.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            water_withdrawal_m: water withdrawal in meters</span>
<span class="sd">            water_consumption_m: water consumption in meters</span>
<span class="sd">            returnFlowIrr_m: return flow in meters</span>
<span class="sd">            addtoevapotrans_m: evaporated irrigation water in meters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activation_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation_order_by_elevation</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_abstraction_m3_by_farmer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_abstraction_m3_by_farmer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groundwater_abstraction_m3_by_farmer</span><span class="p">,</span>
            <span class="n">water_withdrawal_m</span><span class="p">,</span>
            <span class="n">water_consumption_m</span><span class="p">,</span>
            <span class="n">returnFlowIrr_m</span><span class="p">,</span>
            <span class="n">addtoevapotrans_m</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstract_water_numba</span><span class="p">(</span>
            <span class="n">activation_order</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices_per_farmer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_water_limited_days</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_water_efficient</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">irrigating</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groundwater_irrigating</span><span class="p">,</span>
            <span class="n">cell_area</span><span class="p">,</span>
            <span class="n">HRU_to_grid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span><span class="p">,</span>
            <span class="n">totalPotIrrConsumption</span><span class="p">,</span>
            <span class="n">available_channel_storage_m3</span><span class="p">,</span>
            <span class="n">available_groundwater_m3</span><span class="p">,</span>
            <span class="n">groundwater_head</span><span class="p">,</span>
            <span class="n">available_reservoir_storage_m3</span><span class="p">,</span>
            <span class="n">command_areas</span><span class="p">,</span>
            <span class="n">return_fraction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;agent_settings&#39;</span><span class="p">][</span><span class="s1">&#39;farmers&#39;</span><span class="p">][</span><span class="s1">&#39;return_fraction&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">water_withdrawal_m</span><span class="p">,</span>
            <span class="n">water_consumption_m</span><span class="p">,</span>
            <span class="n">returnFlowIrr_m</span><span class="p">,</span>
            <span class="n">addtoevapotrans_m</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Farmers.get_crop_factors"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.get_crop_factors">[docs]</a>    <span class="k">def</span> <span class="nf">get_crop_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads crop factors from disk. The length of the various crop stages is relative and is cumulated to one.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;crop_data&#39;</span><span class="p">,</span> <span class="s1">&#39;crop_factors.csv&#39;</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_dev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_ini&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_dev&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_mid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_dev&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_mid&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_late&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_mid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_late&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;L_late&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">26</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Farmers.get_crop_yield_factors"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.get_crop_yield_factors">[docs]</a>    <span class="k">def</span> <span class="nf">get_crop_yield_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Read csv-file of values for crop water depletion. Obtained from Table 2 of this paper: https://doi.org/10.1016/j.jhydrol.2009.07.031</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            yield_factors: dictonary with np.ndarray of values per crop for each variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">][</span><span class="s1">&#39;input_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;crop_data&#39;</span><span class="p">,</span> <span class="s1">&#39;yield_ratios.csv&#39;</span><span class="p">))</span>
        <span class="n">yield_factors</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;P0&#39;</span><span class="p">,</span> <span class="s1">&#39;P1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
        <span class="n">yield_factors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">yield_factors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">yield_factors</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_day_per_month</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get starting day for each month of year</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            starting_day_per_month: Starting day of each month of year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_day_of_year</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the current day of the year.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            day: current day of the year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>

<div class="viewcode-block" id="Farmers.get_yield_ratio_numba"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.get_yield_ratio_numba">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">get_yield_ratio_numba</span><span class="p">(</span><span class="n">crop_map</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">evap_ratios</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">P0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">P1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate yield ratio based on https://doi.org/10.1016/j.jhydrol.2009.07.031</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            crop_map: array of currently harvested crops.</span>
<span class="sd">            evap_ratios: ratio of actual to potential evapotranspiration of harvested crops.</span>
<span class="sd">            alpha: alpha value per crop used in MIRCA2000.</span>
<span class="sd">            beta: beta value per crop used in MIRCA2000.</span>
<span class="sd">            P0: P0 value per crop used in MIRCA2000.</span>
<span class="sd">            P1: P1 value per crop used in MIRCA2000.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            yield_ratios: yield ratio (as ratio of maximum obtainable yield) per harvested crop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yield_ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">evap_ratios</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">crop_map</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">evap_ratios</span><span class="o">.</span><span class="n">size</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evap_ratios</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">evap_ratio</span> <span class="o">=</span> <span class="n">evap_ratios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">crop</span> <span class="o">=</span> <span class="n">crop_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">alpha</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">*</span> <span class="n">evap_ratio</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">yield_ratio</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">P0</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">evap_ratio</span> <span class="o">&lt;</span> <span class="n">P1</span><span class="p">[</span><span class="n">crop</span><span class="p">]:</span>
                <span class="n">yield_ratio</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">*</span> <span class="n">P1</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">-</span> <span class="n">evap_ratio</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">*</span> <span class="n">P1</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="n">crop</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">-</span> <span class="n">P0</span><span class="p">[</span><span class="n">crop</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">evap_ratio</span> <span class="o">&lt;</span> <span class="n">P0</span><span class="p">[</span><span class="n">crop</span><span class="p">]:</span>
                <span class="n">yield_ratio</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yield_ratio</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span> <span class="o">*</span> <span class="n">evap_ratio</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="n">crop</span><span class="p">]</span>
            <span class="n">yield_ratios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yield_ratio</span>
        
        <span class="k">return</span> <span class="n">yield_ratios</span></div>

<div class="viewcode-block" id="Farmers.get_yield_ratio"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.get_yield_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">get_yield_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">harvest</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">actual_transpiration</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">potential_transpiration</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">crop_map</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets yield ratio for each crop given the ratio between actual and potential evapostranspiration during growth.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            harvest: Map of crops that are harvested.</span>
<span class="sd">            actual_transpiration: Actual evapotranspiration during crop growth period.</span>
<span class="sd">            potential_transpiration: Potential evapotranspiration during crop growth period.</span>
<span class="sd">            crop_map: Subarray of type of crop grown.</span>

<span class="sd">        Returns:</span>
<span class="sd">            yield_ratio: Map of yield ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_yield_ratio_numba</span><span class="p">(</span>
            <span class="n">crop_map</span><span class="p">[</span><span class="n">harvest</span><span class="p">],</span>
            <span class="n">actual_transpiration</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span> <span class="o">/</span> <span class="n">potential_transpiration</span><span class="p">[</span><span class="n">harvest</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop_yield_factors</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop_yield_factors</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop_yield_factors</span><span class="p">[</span><span class="s1">&#39;P0&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop_yield_factors</span><span class="p">[</span><span class="s1">&#39;P1&#39;</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Farmers.save_harvest"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.save_harvest">[docs]</a>    <span class="k">def</span> <span class="nf">save_harvest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">harvesting_farmers</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Saves the current harvest for harvesting farmers in a 2-dimensional array. The first dimension is the different farmers, while the second dimension are the previous harvests. First the previous harvests are moved by 1 column (dropping old harvests when they don&#39;t visit anymore) to make room for the new harvest. Then, the new harvest is placed in the array.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            harvesting_farmers: farmers that harvest in this timestep.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_harvests</span><span class="p">[</span><span class="n">harvesting_farmers</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_harvests</span><span class="p">[</span><span class="n">harvesting_farmers</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_harvests</span><span class="p">[</span><span class="n">harvesting_farmers</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_ratio_per_farmer</span><span class="p">[</span><span class="n">harvesting_farmers</span><span class="p">]</span></div>

<div class="viewcode-block" id="Farmers.invest_in_water_efficiency"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.invest_in_water_efficiency">[docs]</a>    <span class="k">def</span> <span class="nf">invest_in_water_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">harvesting_farmers</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;In the scenario `self_investments` farmers invest in water saving techniques when their harvest starts dropping. Concretely if their harvest is lower than the previous harvests, they do so.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            harvesting_farmers: farmers that harvest in this timestep.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">scenario</span> <span class="o">==</span> <span class="s1">&#39;self_investment&#39;</span><span class="p">:</span>
            <span class="n">invest</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latest_harvests</span><span class="p">[</span><span class="n">harvesting_farmers</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_harvests</span><span class="p">[</span><span class="n">harvesting_farmers</span><span class="p">,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_water_efficient</span><span class="p">[</span><span class="n">harvesting_farmers</span><span class="p">]</span> <span class="o">|=</span> <span class="n">invest</span></div>

<div class="viewcode-block" id="Farmers.get_crop_age_and_harvest_day_initial"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.get_crop_age_and_harvest_day_initial">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">get_crop_age_and_harvest_day_initial</span><span class="p">(</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">current_month</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">current_day</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">planting_schemes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">crop</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">irrigating</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">unit_code</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">planting_scheme</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">start_day_per_month</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">days_in_year</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">365</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the model is initalized, crops are already growing. This function finds out which crops are growing at that stage, and how far in their growth stage they are.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: Number of farmers.</span>
<span class="sd">            current_month: Current month.</span>
<span class="sd">            current_day: Current day.</span>
<span class="sd">            planting_schemes: A 6-dimensional array which contains the planing schemes.</span>

<span class="sd">               1. Whether the crop is irrigated or not.</span>
<span class="sd">               2. The unit code for the crop.</span>
<span class="sd">               3. The crop.</span>
<span class="sd">               4. The planting scheme (e.g., single or double cropping).</span>
<span class="sd">               5. If multicropping, the various crop stages.</span>
<span class="sd">               6. The planting month and the harvest month.</span>
<span class="sd">            crop: Crops grown by each farmer.</span>
<span class="sd">            irrigating: Whether each farmers irrigates or not (True is irrigating, False is not).</span>
<span class="sd">            unit_code: The unit code of each farmer.</span>
<span class="sd">            planting_scheme: The planting scheme for each farmer.</span>
<span class="sd">            start_day_per_month: The starting day of the year for each month.</span>
<span class="sd">            days_in_year: Number of days in year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crop_age_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">crop_harvest_age_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">next_plant_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">next_multicrop_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">n_multicrop_periods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">days_in_year</span> <span class="o">==</span> <span class="mi">365</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">farmer_planting_scheme</span> <span class="o">=</span> <span class="n">planting_schemes</span><span class="p">[</span><span class="n">irrigating</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unit_code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">planting_scheme</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">n_cropping_periods</span> <span class="o">=</span> <span class="p">(</span><span class="n">farmer_planting_scheme</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">n_multicrop_periods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="n">n_cropping_periods</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cropping_periods</span><span class="p">):</span>
                <span class="n">currently_planted</span> <span class="o">=</span> <span class="n">is_currently_growing</span><span class="p">(</span><span class="n">farmer_planting_scheme</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">farmer_planting_scheme</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">current_month</span><span class="p">,</span> <span class="n">current_day</span><span class="p">,</span> <span class="n">start_day_per_month</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">currently_planted</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">crop_age_days</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">currently_planted</span>
                    <span class="n">crop_data</span> <span class="o">=</span> <span class="n">farmer_planting_scheme</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_day_per_month</span><span class="p">[</span><span class="n">crop_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">crop_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="mi">365</span>
                    <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">n_cropping_periods</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">next_plant_day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">farmer_planting_scheme</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># no crops are currently planted, so let&#39;s find out the first crop with a plant day</span>
                <span class="k">assert</span> <span class="n">n_cropping_periods</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cropping_periods</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if first option, just set it as the next plant day</span>
                        <span class="n">next_plant_day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">farmer_planting_scheme</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if not, find the first option starting from the current day</span>
                        <span class="n">potential_next_plant_day</span> <span class="o">=</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">farmer_planting_scheme</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">next_plant_day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">min</span><span class="p">((</span><span class="n">potential_next_plant_day</span> <span class="o">-</span> <span class="n">current_day</span><span class="p">)</span> <span class="o">%</span> <span class="n">days_in_year</span><span class="p">,</span> <span class="p">(</span><span class="n">next_plant_day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_day</span><span class="p">)</span> <span class="o">%</span> <span class="n">days_in_year</span><span class="p">))</span> <span class="o">+</span> <span class="n">current_day</span><span class="p">)</span> <span class="o">%</span> <span class="n">days_in_year</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cropping_periods</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">farmer_planting_scheme</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">next_plant_day</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># make sure one of the options is picked</span>
                    <span class="k">assert</span> <span class="kc">False</span>

            <span class="k">assert</span> <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">next_plant_day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">next_multicrop_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">n_multicrop_periods</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">crop_age_days</span><span class="p">,</span> <span class="n">crop_harvest_age_days</span><span class="p">,</span> <span class="n">next_plant_day</span><span class="p">,</span> <span class="n">n_multicrop_periods</span><span class="p">,</span> <span class="n">next_multicrop_index</span></div>

    <span class="k">def</span> <span class="nf">by_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">nofieldvalue</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">by_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_owners</span><span class="p">)</span>
        <span class="n">by_field</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_owners</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nofieldvalue</span>
        <span class="k">return</span> <span class="n">by_field</span>
        
<div class="viewcode-block" id="Farmers.plant_initial"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.plant_initial">[docs]</a>    <span class="k">def</span> <span class="nf">plant_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;When the model is initalized, crops are already growing. This function first finds out which farmers are already growing crops, how old these are, as well as the multicrop indices. Then, these arrays per farmer are converted to the field array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">crop_age_days</span><span class="p">,</span> <span class="n">crop_harvest_age_days</span><span class="p">,</span> <span class="n">next_plant_day</span><span class="p">,</span> <span class="n">n_multicrop_periods</span><span class="p">,</span> <span class="n">next_multicrop_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_crop_age_and_harvest_day_initial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_day_of_year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">planting_schemes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">irrigating</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">planting_scheme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day_per_month</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">((</span><span class="n">next_plant_day</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">crop_harvest_age_days</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
            <span class="n">crop_age_days</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">crop_age_days</span><span class="p">)</span>
            <span class="n">crop_harvest_age_days</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">crop_harvest_age_days</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
            <span class="n">plant</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">plant</span><span class="p">[</span><span class="n">crop_age_days</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="n">plant</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="n">crop_age_days</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="n">crop_harvest_age_days</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">next_plant_day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="n">next_plant_day</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">n_multicrop_periods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="n">n_multicrop_periods</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">next_multicrop_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="n">next_multicrop_index</span><span class="p">)</span>
                
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">field_is_paddy_irrigated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_paddy_irrigated</span><span class="p">,</span> <span class="n">nofieldvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">field_is_paddy_irrigated</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">field_is_paddy_irrigated</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">3</span></div>

<div class="viewcode-block" id="Farmers.harvest_numba"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.harvest_numba">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">harvest_numba</span><span class="p">(</span>
        <span class="n">n</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">start_day_per_month</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">field_indices_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">field_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">crop_map</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">crop_age_days</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">crop_harvest_age_days</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">n_water_limited_days</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">next_plant_day</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">next_multicrop_index</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">n_multicrop_periods</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">planting_schemes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">irrigating</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">unit_code</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">crop</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">planting_scheme</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">switch_crops</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">field_size_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function determines whether crops are ready to be harvested by comparing the crop harvest age to the current age of the crop. If the crop is harvested, the crops next multicrop index and next plant day are determined.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: Number of farmers.</span>
<span class="sd">            start_day_per_month: Array containing the starting day of each month.</span>
<span class="sd">            field_indices_per_farmer: This array contains the indices where the fields of a farmer are stored in `field_indices`.</span>
<span class="sd">            field_indices: This array contains the indices of all fields, ordered by farmer. In other words, if a farmer owns multiple fields, the indices of the fields are indices.  </span>
<span class="sd">            crop_map: Subarray map of crops.</span>
<span class="sd">            crop_age_days: Subarray map of current crop age in days.</span>
<span class="sd">            crop_harvest_age_days: Subarray map of crop harvest age in days.</span>
<span class="sd">            n_water_limited_days: Number of days that crop was water limited.</span>
<span class="sd">            next_plant_day: Subarray map of next planting day.</span>
<span class="sd">            next_multicrop_index: Subarray map of the next multicropping index.</span>
<span class="sd">            n_multicrop_periods: Subarray map of the number of multicropping periods.</span>
<span class="sd">            planting_schemes: A 6-dimensional array which contains the planing schemes.</span>

<span class="sd">               1. Whether the crop is irrigated or not.</span>
<span class="sd">               2. The unit code for the crop.</span>
<span class="sd">               3. The crop.</span>
<span class="sd">               4. The planting scheme (e.g., single or double cropping).</span>
<span class="sd">               5. If multicropping, the various crop stages.</span>
<span class="sd">               6. The planting month and the harvest month.</span>
<span class="sd">            irrigating: Whether each farmers irrigates or not (True is irrigating, False is not).</span>
<span class="sd">            unit_code: The unit code of each farmer.</span>
<span class="sd">            crop: Crops grown by each farmer.</span>
<span class="sd">            planting_scheme: The planting scheme for each farmer.</span>
<span class="sd">            switch_crops: Whether to switch crops or not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            harvest: Boolean subarray map of fields to be harvested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">harvest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">crop_map</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">farmer_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">switch_if_not_limited</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">.3</span>
            <span class="n">farmer_fields</span> <span class="o">=</span> <span class="n">get_farmer_fields</span><span class="p">(</span><span class="n">field_indices</span><span class="p">,</span> <span class="n">field_indices_per_farmer</span><span class="p">,</span> <span class="n">farmer_i</span><span class="p">)</span>
            <span class="n">n_water_limited_days_farmer</span> <span class="o">=</span> <span class="n">n_water_limited_days</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">farmer_fields</span><span class="p">:</span>
                <span class="n">crop_age</span> <span class="o">=</span> <span class="n">crop_age_days</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">crop_age</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">crop_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">assert</span> <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">crop_age</span> <span class="o">==</span> <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                        <span class="n">harvest</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        
                        <span class="k">if</span> <span class="n">switch_crops</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">n_water_limited_days_farmer</span> <span class="o">&lt;</span> <span class="mf">.5</span> <span class="o">*</span> <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">and</span> <span class="n">field_size_per_farmer</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5000</span> <span class="ow">and</span> <span class="n">switch_if_not_limited</span><span class="p">:</span>  <span class="c1"># switch to sugar cane</span>
                                <span class="n">crop</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
                                <span class="n">planting_scheme</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">n_multicrop_periods</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        
                        <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_multicrop_periods</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n_multicrop_periods</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> 
                        <span class="n">next_plant_month</span> <span class="o">=</span> <span class="n">planting_schemes</span><span class="p">[</span><span class="n">irrigating</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">],</span> <span class="n">unit_code</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">],</span> <span class="n">crop</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">],</span> <span class="n">planting_scheme</span><span class="p">[</span><span class="n">farmer_i</span><span class="p">],</span> <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">field</span><span class="p">]]</span>
                        <span class="k">assert</span> <span class="n">next_plant_month</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">next_plant_day</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">next_plant_month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">crop_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">assert</span> <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">harvest</span></div>
        
<div class="viewcode-block" id="Farmers.harvest"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.harvest">[docs]</a>    <span class="k">def</span> <span class="nf">harvest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function determines which crops needs to be harvested, based on the current age of the crops and the harvest age of the crop. First a helper function is used to obtain the harvest map. Then, if at least 1 field is harvested, the yield ratio is obtained for all fields using the ratio of actual to potential evapotranspiration, saves the harvest per farmer and potentially invests in water saving techniques.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">actual_transpiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_transpiration_crop</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_transpiration_crop</span>
        <span class="n">potential_transpiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">potential_transpiration_crop</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">potential_transpiration_crop</span>
        <span class="n">crop_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span>
        <span class="n">crop_age_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span>
        <span class="n">crop_harvest_age_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span>
        <span class="n">harvest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harvest_numba</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_day_per_month</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices_per_farmer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices</span><span class="p">,</span>
            <span class="n">crop_map</span><span class="p">,</span>
            <span class="n">crop_age_days</span><span class="p">,</span>
            <span class="n">crop_harvest_age_days</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_water_limited_days</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">next_plant_day</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">next_multicrop_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">n_multicrop_periods</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">planting_schemes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">irrigating</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_code</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">planting_scheme</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">switch_crops</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_size_per_farmer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">harvest</span><span class="p">):</span>
            <span class="n">yield_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_yield_ratio</span><span class="p">(</span><span class="n">harvest</span><span class="p">,</span> <span class="n">actual_transpiration</span><span class="p">,</span> <span class="n">potential_transpiration</span><span class="p">,</span> <span class="n">crop_map</span><span class="p">)</span>
            <span class="n">harvesting_farmer_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_owners</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yield_ratio_per_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">harvesting_farmer_fields</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">yield_ratio</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">harvesting_farmers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">harvesting_farmer_fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_timestep</span> <span class="o">&gt;</span> <span class="mi">365</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_harvest</span><span class="p">(</span><span class="n">harvesting_farmers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invest_in_water_efficiency</span><span class="p">(</span><span class="n">harvesting_farmers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yield_ratio_per_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
            <span class="n">harvest</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">harvest</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">actual_transpiration_crop</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">potential_transpiration_crop</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># remove crops from crop_map where they are harvested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># when a crop is harvested set to non irrigated land</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">[</span><span class="n">harvest</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># increase crop age by 1 where crops are not harvested and growing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span><span class="p">[(</span><span class="n">harvest</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Farmers.plant_numba"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.plant_numba">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">plant_numba</span><span class="p">(</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">start_day_per_month</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">current_day</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">next_plant_day</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">crop</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">field_indices_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">field_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">planting_schemes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">irrigating</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">n_water_limited_days</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">unit_code</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">planting_scheme</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">next_multicrop_index</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Determines when and what crop should be planted, by comparing the current day to the next plant day. Also sets the haverst age of the plant.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            n: Number of farmers.</span>
<span class="sd">            start_day_per_month: Starting day of each month of year.</span>
<span class="sd">            current_day: Current day.</span>
<span class="sd">            next_plant_day: Subarray map of next planting day.</span>
<span class="sd">            crop: Crops grown by each farmer. </span>
<span class="sd">            field_indices_per_farmer: This array contains the indices where the fields of a farmer are stored in `field_indices`.</span>
<span class="sd">            field_indices: This array contains the indices of all fields, ordered by farmer. In other words, if a farmer owns multiple fields, the indices of the fields are indices. </span>
<span class="sd">            planting_schemes: A 6-dimensional array which contains the planing schemes.</span>

<span class="sd">               1. Whether the crop is irrigated or not.</span>
<span class="sd">               2. The unit code for the crop.</span>
<span class="sd">               3. The crop.</span>
<span class="sd">               4. The planting scheme (e.g., single or double cropping).</span>
<span class="sd">               5. If multicropping, the various crop stages.</span>
<span class="sd">               6. The planting month and the harvest month.</span>
<span class="sd">            irrigating: Whether each farmers irrigates or not (True is irrigating, False is not).</span>
<span class="sd">            unit_code: The unit code of each farmer.</span>
<span class="sd">            planting_scheme: The planting scheme for each farmer.</span>
<span class="sd">            next_multicrop_index: Subarray map of the next multicropping index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            plant: Subarray map of what crops are plantn this day.</span>
<span class="sd">            crop_harvest_age_days: Subarray map of the havest age in days.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">next_plant_day</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">crop_harvest_age_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">next_plant_day</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">farmer_fields</span> <span class="o">=</span> <span class="n">get_farmer_fields</span><span class="p">(</span><span class="n">field_indices</span><span class="p">,</span> <span class="n">field_indices_per_farmer</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">farmer_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">next_plant_day</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">next_plant_day</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_day</span><span class="p">:</span>
                    <span class="n">plant</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">crop_data</span> <span class="o">=</span> <span class="n">planting_schemes</span><span class="p">[</span><span class="n">irrigating</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unit_code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">planting_scheme</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">next_multicrop_index</span><span class="p">[</span><span class="n">field</span><span class="p">]]</span>
                    <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_day_per_month</span><span class="p">[</span><span class="n">crop_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_day_per_month</span><span class="p">[</span><span class="n">crop_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="mi">365</span>
                    <span class="n">n_water_limited_days</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">plant</span><span class="p">,</span> <span class="n">crop_harvest_age_days</span></div>

<div class="viewcode-block" id="Farmers.plant"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.plant">[docs]</a>    <span class="k">def</span> <span class="nf">plant</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determines when and what crop should be planted, mainly through calling the :meth:`agents.farmers.Farmers.plant_numba`. Then converts the array to cupy array if model is running with GPU.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plant_map</span><span class="p">,</span> <span class="n">crop_harvest_age_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_numba</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_day_per_month</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_day_of_year</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">next_plant_day</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices_per_farmer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">planting_schemes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">irrigating</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_water_limited_days</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_code</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">planting_scheme</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">next_multicrop_index</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
            <span class="n">plant_map</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plant_map</span><span class="p">)</span>
            <span class="n">crop_harvest_age_days</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">crop_harvest_age_days</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">plant_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">plant_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span><span class="p">[</span><span class="n">plant_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span><span class="p">[</span><span class="n">plant_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_harvest_age_days</span><span class="p">[</span><span class="n">plant_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_harvest_age_days_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_age_days_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">field_is_paddy_irrigated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_paddy_irrigated</span><span class="p">,</span> <span class="n">nofieldvalue</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">field_is_paddy_irrigated</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">land_use_type</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">crop_map</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">field_is_paddy_irrigated</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">3</span></div>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locations</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@locations</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locations</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_paddy_irrigated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paddy_irrigated</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@is_paddy_irrigated</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">is_paddy_irrigated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_paddy_irrigated</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yield_ratio_per_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yield_ratio_per_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@yield_ratio_per_farmer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">yield_ratio_per_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yield_ratio_per_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crop</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@crop</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_crop</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">latest_harvests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_harvests</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@latest_harvests</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">latest_harvests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_harvests</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">irrigating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_irrigating</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@irrigating</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">irrigating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_irrigating</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">groundwater_irrigating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groundwater_irrigating</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@groundwater_irrigating</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">groundwater_irrigating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_groundwater_irrigating</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unit_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_code</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@unit_code</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">unit_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit_code</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">planting_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_planting_scheme</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@planting_scheme</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">planting_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_planting_scheme</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_water_efficient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_water_efficient</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@is_water_efficient</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">is_water_efficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_water_efficient</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elevation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elevation</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@elevation</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">elevation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_elevation</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reservoir_abstraction_m3_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reservoir_abstraction_m3_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@reservoir_abstraction_m3_by_farmer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">reservoir_abstraction_m3_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_reservoir_abstraction_m3_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">groundwater_abstraction_m3_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groundwater_abstraction_m3_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@groundwater_abstraction_m3_by_farmer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">groundwater_abstraction_m3_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_groundwater_abstraction_m3_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channel_abstraction_m3_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_abstraction_m3_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@channel_abstraction_m3_by_farmer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">channel_abstraction_m3_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_abstraction_m3_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">water_availability_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_water_availability_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@water_availability_by_farmer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">water_availability_by_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_water_availability_by_farmer</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_water_limited_days</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_water_limited_days</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>

    <span class="nd">@n_water_limited_days</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">n_water_limited_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_water_limited_days</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Farmers.field_size_per_farmer_numba"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.field_size_per_farmer_numba">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span>
    <span class="k">def</span> <span class="nf">field_size_per_farmer_numba</span><span class="p">(</span><span class="n">field_indices_per_farmer</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">field_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cell_area</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the field size for each farmer.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_indices_per_farmer: This array contains the indices where the fields of a farmer are stored in `field_indices`.</span>
<span class="sd">            field_indices: This array contains the indices of all fields, ordered by farmer. In other words, if a farmer owns multiple fields, the indices of the fields are indices.  </span>
<span class="sd">            cell_area: Subarray of cell_area.</span>

<span class="sd">        Returns:</span>
<span class="sd">            field_size_per_farmer: Field size for each farmer in m2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_size_per_farmer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">field_indices_per_farmer</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">farmer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">field_indices_per_farmer</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">get_farmer_fields</span><span class="p">(</span><span class="n">field_indices</span><span class="p">,</span> <span class="n">field_indices_per_farmer</span><span class="p">,</span> <span class="n">farmer</span><span class="p">):</span>
                <span class="n">field_size_per_farmer</span><span class="p">[</span><span class="n">farmer</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cell_area</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">field_size_per_farmer</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">field_size_per_farmer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the field size for each farmer.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            field_size_per_farmer: Field size for each farmer in m2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_size_per_farmer_numba</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices_per_farmer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_indices</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">use_gpu</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Farmers.diffuse_water_efficiency_knowledge"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.diffuse_water_efficiency_knowledge">[docs]</a>    <span class="k">def</span> <span class="nf">diffuse_water_efficiency_knowledge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When this method is called, all farmers that have a high water efficiency, spread knowledge to a maximum of three other farmers within 5000 meter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">water_efficient_farmers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_water_efficient</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">find_neighbors</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">,</span>
            <span class="mi">5000</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">29</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="s1">&#39;longlat&#39;</span><span class="p">,</span>
            <span class="n">search_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">water_efficient_farmers</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">water_efficient_farmers</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">100</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">neighbors</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_water_efficient</span><span class="p">[</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Farmers.step"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called at the beginning of each timestep. First, in the `ngo_training` scenario water efficiency knowledge diffuses through the farmer population. Only occurs each year on January 1st.</span>

<span class="sd">        Then, farmers harvest and plant crops.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">scenario</span> <span class="o">==</span> <span class="s1">&#39;ngo_training&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diffuse_water_efficiency_knowledge</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">harvest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plant</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="Farmers.add_agents"><a class="viewcode-back" href="../../agents/farmers.html#agents.farmers.Farmers.add_agents">[docs]</a>    <span class="k">def</span> <span class="nf">add_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function can be used to add new farmers, but is not yet implemented.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2022, IIASA and VU-IVM.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>